<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <link rel="stylesheet" href="/static/monitor_main.css">
</head>
<body>
    <div class="navbar">
        <span onclick="window.location.href='GD.html'">DASHBOARDS</span>
        <span onclick="window.location.href='monitor_main.html'" class="active">DIAGRAMS</span>
        <span onclick="window.location.href='dashboard_real'">TRENDS</span>
        <span onclick="window.location.href='Alarm.html'">ALARMS</span>
        <span onclick="window.location.href='Report.html'">REPORTS</span>
        <span onclick="window.location.href='Setting-current.html'">SETTING</span>
        <span id="logoutSpan" onclick="handleLogout()">LOG OUT</span>
        <span id="userInfo" style="margin-left: auto"></span>
    </div>
    <div class="container">
        <div class="sidebar">
            <div>1 - T·ªîNG H·ª¢P</div>
            <div onclick="window.location.href='day_tn.html'">2 - CHI TI·∫æT</div>
        </div>
        <div class="main-content">
            <img    id="device1-green" 
                    class="status-dot" 
                     src="/pictures/blue-icon.png" 
                    style="top: 335px; left: 355px;">
            <img    id="device1-red" 
                    class="status-dot" 
                    src="/pictures/red-icon.png" 
                    style="top: 335px; left: 355px; display: none;">

            <img    id="device2-green" 
                    class="status-dot" 
                     src="/pictures/blue-icon.png" 
                    style="top: 335px; left: 468px;">
            <img    id="device2-red" 
                    class="status-dot" 
                    src="/pictures/red-icon.png" 
                    style="top: 335px; left: 468px; display: none;">

            <img    id="device3-green" 
                    class="status-dot" 
                     src="/pictures/blue-icon.png" 
                    style="top: 335px; left: 678px;">
            <img    id="device3-red" 
                    class="status-dot" 
                    src="/pictures/red-icon.png" 
                    style="top: 335px; left: 678px; display: none;">

            <img    id="device4-green" 
                    class="status-dot" 
                     src="/pictures/blue-icon.png" 
                    style="top: 335px; left: 790px;">
            <img    id="device4-red" 
                    class="status-dot" 
                    src="/pictures/red-icon.png" 
                    style="top: 335px; left: 790px; display: none;">
        
            </div>
        </div>
    </div>
    <script>
        async function updateGatawayStatus() {
        try {
            const response = await fetch("http://localhost:3000/api/gataway-status-real");
            const statusData = await response.json();

            updateIndicator("device1", statusData.device1);
            updateIndicator("device2", statusData.device2);
            updateIndicator("device3", statusData.device3);
            updateIndicator("device4", statusData.device4);

        } catch (error) {
            console.error("L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i:", error);
        }
    }

    function updateIndicator(deviceId, isConnected) {
        const greenDot = document.getElementById(`${deviceId}-green`);
        const redDot = document.getElementById(`${deviceId}-red`);
        if (isConnected) {
            greenDot.style.display = "block";
            redDot.style.display = "none";
        } else {
            greenDot.style.display = "none";
            redDot.style.display = "block";
        }
    }

    function handleLogout() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
        logout().then(() => {
            window.location.href = 'index.html';
        }).catch(error => {
            console.error('L·ªói khi ƒëƒÉng xu·∫•t:', error);
            alert('ƒêƒÉng xu·∫•t th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
        });
    }
}
async function logout() {
    try {
        const response = await fetch('http://127.0.0.1:3000/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',  // ‚ö†Ô∏è Quan tr·ªçng: g·ª≠i cookie (sessionID)
        });
        const data = await response.json();
        console.log('Ph·∫£n h·ªìi t·ª´ server:', data.message);

        // X√≥a role kh·ªèi localStorage
        localStorage.removeItem('role');
        return data; // Tr·∫£ v·ªÅ ƒë·ªÉ x·ª≠ l√Ω trong then
    } catch (error) {
        throw error; // N√©m l·ªói ƒë·ªÉ catch b√™n ngo√†i x·ª≠ l√Ω
    }
}

    setInterval(updateGatawayStatus, 5000);
          getSessionInfo();
      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi d√πng khi trang load
      document.addEventListener('DOMContentLoaded', async function () {
        const userInfoSpan = document.getElementById('userInfo');
        if (userInfoSpan) {
          const userDisplay = await getSessionInfo();
          userInfoSpan.textContent = 'Xin ch√†o, ' + userDisplay;
        }
      });
      async function getSessionInfo() {
        try {
          const response = await fetch('http://127.0.0.1:3000/get-session', {
            method: 'GET',
            credentials: 'include' // Bao g·ªìm cookie/session
          });
          const data = await response.json();
          if (response.ok) {
            let userDisplay = data.email;
            if (data.role === 'admin') {
              userDisplay += ' üîë';
            }
            return userDisplay;
          } else {
            return 'Guest'; // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
          }
        } catch (error) {
          console.error('L·ªói khi l·∫•y session:', error);
          return 'Guest';
        }
      }
    </script>
</body>
</html>
