<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .navbar {
        background-color: #4caf50;
        color: white;
        padding: 10px;
        display: flex;
        gap: 15px;
      }
      .navbar span {
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background 0.3s;
      }
      .navbar span:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .navbar span.active {
        font-weight: bold;
        color: rgb(254, 174, 0);
      }
      .container {
        display: flex;
        flex: 1;
      }
      .sidebar {
        width: 250px;
        background: #f4f4f4;
        padding: 15px;
      }
      .sidebar div {
        margin-bottom: 10px;
        cursor: pointer;
        font-size: 14px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: white;
        transition: background 0.3s;
      }
      .sidebar div:hover {
        background: rgba(0, 0, 0, 0.1);
      }
      .sidebar div.active {
        font-weight: bold;
        color: rgb(254, 174, 0);
      }
      .main-content {
        flex: 1;
        padding: 20px;
        background: #fff;
        display: flex;
        flex-direction: column;
      }
      h2 {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
        text-align: center;
        color: #333;
      }
      .top-section {
        display: flex;
        height: 50%;
        flex-grow: 1;
        gap: 20px;
      }
      .bottom-section {
        height: 50%;
        padding: 10px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
      }
      .box {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }
      .pie-chart {
        background: white;
        width: 100%;
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        position: relative;
        min-height: 460px; /* ƒê·∫£m b·∫£o ƒë·ªß kh√¥ng gian cho chart-wrapper v√† chart-header */
        padding: 20px;
      }
      .bar-chart {
        background: white;
        width: 100%;
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        position: relative;
      }
      .chart-wrapper {
        width: 100%;
        height: 300px;
        position: relative;
      }
      .chart-wrapper canvas {
        width: 100% !important;
        height: 100% !important;
      }
      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      .chart-header h3 {
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }
      .chart-header input {
        border: 1px solid #ccc;
        padding: 8px;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
      }
      .bar-chart-wrapper {
        height: 500px; /* ƒê·ªô cao ri√™ng cho bi·ªÉu ƒë·ªì c·ªôt */
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <span onclick="window.location.href='GD.html'" class="active">DASHBOARDS</span>
      <span onclick="window.location.href='monitor_main.html'">DIAGRAMS</span>
      <span onclick="window.location.href='dashboard_linechart.html'">TRENDS</span>
      <span onclick="window.location.href='Alarm.html'">ALARMS</span>
      <span onclick="window.location.href='Report.html'">REPORTS</span>
      <span onclick="window.location.href='Setting-current.html'">SETTING</span>
      <span id="logoutSpan" onclick="handleLogout()">LOG OUT</span>
      <span id="userInfo" style="margin-left: auto"></span>
    </div>
    <div class="container">
      <div class="sidebar">
        <div onclick="window.location.href='GD.html'" class="active">1 - T·ªîNG H·ª¢P</div>
        <div onclick="window.location.href='Area_1.html'">2 - KHU V·ª∞C 1</div>
        <div onclick="window.location.href='Area_2.html'">3 - KHU V·ª∞C 2</div>
        <div onclick="window.location.href='Area_3.html'">4 - KHU V·ª∞C 3</div>
        <div onclick="window.location.href='Area_4.html'">5 - KHU V·ª∞C 4</div>
        <div onclick="window.location.href='CompareEnergy.html'">6 - SO S√ÅNH</div>
      </div>
      <div class="main-content">
        <h2>BI·ªÇU ƒê·ªí T·ªîNG QUAN ƒêI·ªÜN NƒÇNG TI√äU TH·ª§</h2>
        <div class="top-section">
          <div class="box">
            <div class="pie-chart">
              <div class="chart-header">
                <h3>ƒêI·ªÜN NƒÇNG S·ª¨ D·ª§NG</h3>
                <input type="date" id="datePicker1" />
              </div>
              <div class="chart-wrapper">
                <canvas id="chart1"></canvas>
              </div>
            </div>
          </div>
          <div class="box">
            <div class="pie-chart">
              <div class="chart-header">
                <h3>ƒêI·ªÜN NƒÇNG TU·∫¶N N√ÄY</h3>
              </div>
              <div class="chart-wrapper">
                <canvas id="chart2"></canvas>
              </div>
            </div>
          </div>
          <div class="box">
            <div class="pie-chart">
              <div class="chart-header">
                <h3>ƒêI·ªÜN NƒÇNG THEO TH√ÅNG</h3>
                <input type="month" id="monthPicker" />
              </div>
              <div class="chart-wrapper">
                <canvas id="chart3"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="bottom-section">
          <div class="bar-chart">
            <div class="chart-header">
              <h3>T·ªîNG ƒêI·ªÜN NƒÇNG S·ª¨ D·ª§NG</h3>
              <input type="month" id="monthPickerBar" />
            </div>
            <div class="chart-wrapper bar-chart-wrapper">
              <canvas id="chart4"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      Chart.register(ChartDataLabels);

      let chartDay = null;
      let chartWeek = null;
      let chartMonth = null;
      let chartSummary = null;

      async function fetchValuePieChartData(chartId, date) {
        if (!date) return;
        try {
          const response = await fetch(`http://localhost:3000/api/getDailyEnergyByIP?date=${date}`);
          if (!response.ok) throw new Error('L·ªói khi g·ªçi API!');
          const chartData = await response.json();
          if (!chartData || !chartData.data || chartData.data.length === 0) {
            console.error('‚õî Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì!');
            return;
          }
          if (chartDay) chartDay.destroy();
          chartDay = new Chart(document.getElementById(chartId), {
            type: 'pie',
            data: {
              labels: chartData.labels,
              datasets: [
                {
                  data: chartData.data,
                  backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4CAF50']
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                datalabels: {
                  color: 'white',
                  font: { weight: 'bold', size: 14 },
                  formatter: (value, ctx) => {
                    let sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                    return ((value / sum) * 100).toFixed(1) + '%';
                  }
                }
              }
            }
          });
        } catch (error) {
          console.error('üö® L·ªói khi l·∫•y d·ªØ li·ªáu bi·ªÉu ƒë·ªì:', error);
        }
      }

      async function fetchSumPieChartData(chartId) {
        try {
          const response = await fetch('http://localhost:3000/api/getWeeklyEnergyByIP');
          const chartData = await response.json();
          if (!chartData || !chartData.data || chartData.data.length === 0) {
            console.error('‚õî Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì!');
            return;
          }
          if (chartWeek) chartWeek.destroy();
          chartWeek = new Chart(document.getElementById(chartId), {
            type: 'pie',
            data: {
              labels: chartData.labels,
              datasets: [
                {
                  data: chartData.data,
                  backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4CAF50']
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                datalabels: {
                  color: 'white',
                  font: { weight: 'bold', size: 14 },
                  formatter: (value, ctx) => {
                    let sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                    return ((value / sum) * 100).toFixed(1) + '%';
                  }
                }
              }
            }
          });
        } catch (error) {
          console.error('üö® L·ªói khi l·∫•y d·ªØ li·ªáu bi·ªÉu ƒë·ªì:', error);
        }
      }

      async function fetchMonthPieChartData(chartId, month) {
        if (!month) return;
        try {
          const response = await fetch(
            `http://localhost:3000/api/getMonthlyEnergyByIP?month=${month}`
          );
          if (!response.ok) throw new Error('L·ªói khi g·ªçi API!');
          const chartData = await response.json();
          if (!chartData || !chartData.data || chartData.data.length === 0) {
            console.error('‚õî Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì!');
            return;
          }
          if (chartMonth) chartMonth.destroy();
          chartMonth = new Chart(document.getElementById(chartId), {
            type: 'pie',
            data: {
              labels: chartData.labels,
              datasets: [
                {
                  data: chartData.data,
                  backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4CAF50']
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                datalabels: {
                  color: 'white',
                  font: { weight: 'bold', size: 14 },
                  formatter: (value, ctx) => {
                    let sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                    return ((value / sum) * 100).toFixed(1) + '%';
                  }
                }
              }
            }
          });
        } catch (error) {
          console.error('üö® L·ªói khi l·∫•y d·ªØ li·ªáu bi·ªÉu ƒë·ªì:', error);
        }
      }

      async function fetchBarChartData(chartId, month) {
        if (!month) return;
        try {
          const response = await fetch(
            `http://localhost:3000/api/getDailyEnergyChartOfMonth?month=${month}`
          );
          if (!response.ok) throw new Error('L·ªói khi g·ªçi API!');
          const chartData = await response.json();
          if (!chartData || !chartData.data || chartData.data.length === 0) {
            console.warn('‚õî Kh√¥ng c√≥ d·ªØ li·ªáu cho th√°ng n√†y!');
            return;
          }
          if (chartSummary) chartSummary.destroy();
          chartSummary = new Chart(document.getElementById(chartId), {
            type: 'bar',
            data: {
              labels: chartData.labels,
              datasets: [
                {
                  label: 'T·ªïng ƒëi·ªán nƒÉng ti√™u th·ª•',
                  data: chartData.data.map((value) => parseFloat((value || 0).toFixed(2))),
                  backgroundColor: '#36A2EB'
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'kWh'
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: 'Ng√†y'
                  }
                }
              }
            }
          });
        } catch (error) {
          console.error('üö® L·ªói khi l·∫•y d·ªØ li·ªáu bi·ªÉu ƒë·ªì:', error);
        }
      }

      document.getElementById('datePicker1').addEventListener('change', function () {
        const selectedDate = this.value;
        if (selectedDate) fetchValuePieChartData('chart1', selectedDate);
      });

      fetchSumPieChartData('chart2');

      document.getElementById('monthPicker').addEventListener('change', function () {
        const selectedMonth = this.value;
        if (selectedMonth) fetchMonthPieChartData('chart3', selectedMonth);
      });

      document.getElementById('monthPickerBar').addEventListener('change', function () {
        const selectedMonth = this.value;
        if (selectedMonth) fetchBarChartData('chart4', selectedMonth);
      });

      function handleLogout() {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
          logout()
            .then(() => {
              window.location.href = 'index.html';
            })
            .catch((error) => {
              console.error('L·ªói khi ƒëƒÉng xu·∫•t:', error);
              alert('ƒêƒÉng xu·∫•t th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
            });
        }
      }

      async function logout() {
        try {
          const response = await fetch('http://127.0.0.1:3000/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include'
          });
          const data = await response.json();
          console.log('Ph·∫£n h·ªìi t·ª´ server:', data.message);
          localStorage.removeItem('role');
          return data;
        } catch (error) {
          throw error;
        }
      }
      getSessionInfo();
      // C·∫≠p nh·∫≠t hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi d√πng khi trang load
      document.addEventListener('DOMContentLoaded', async function () {
        const userInfoSpan = document.getElementById('userInfo');
        if (userInfoSpan) {
          const userDisplay = await getSessionInfo();
          userInfoSpan.textContent = 'Xin ch√†o, ' + userDisplay;
        }
      });
      async function getSessionInfo() {
        try {
          const response = await fetch('http://127.0.0.1:3000/get-session', {
            method: 'GET',
            credentials: 'include' // Bao g·ªìm cookie/session
          });
          const data = await response.json();
          if (response.ok) {
            let userDisplay = data.email;
            if (data.role === 'admin') {
              userDisplay += ' üîë';
            }
            return userDisplay;
          } else {
            return 'Guest'; // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
          }
        } catch (error) {
          console.error('L·ªói khi l·∫•y session:', error);
          return 'Guest';
        }
      }
    </script>
  </body>
</html>
