<button id="logout">Log out</button>

<div id="modbus-data">
    <div id="val1">Loading...</div>
    <div id="val2">Loading...</div>
    <div id="val3">Loading...</div>
    <div id="val4">Loading...</div>
    <div id="val5">Loading...</div>
</div>

<div>
    <input type="text" id="deviceIp" placeholder="Nh·∫≠p IP thi·∫øt b·ªã (VD: 192.168.0.101)">
    <input type="number" id="slaveId" placeholder="Nh·∫≠p Slave ID (VD: 1)">
    <button onclick="fetchModbusData()">L·∫•y D·ªØ Li·ªáu</button>
</div>

<div id="status"></div>

<div>
    <input type="number" id="register" placeholder="Nh·∫≠p thanh ghi (VD: 3)">
    <input type="number" id="value" placeholder="Nh·∫≠p gi√° tr·ªã (VD: 1)">
    <button onclick="writeModbus()">Ghi D·ªØ Li·ªáu</button>
    <button onclick="viewDetails('127.0.0.1', 1)">Xem chi ti·∫øt</button>
</div>

<div id="status"></div>

<!-- Khu v·ª±c hi·ªÉn th·ªã JSON tr·∫£ v·ªÅ -->
<pre id="json-output" style="background: #f4f4f4; padding: 10px; border: 1px solid #ddd;"></pre>

<script>
    async function writeModbus() {
        let register = document.getElementById("register").value;
        let value = document.getElementById("value").value;

        if (register === "" || value === "") {
            alert("Vui l√≤ng nh·∫≠p thanh ghi v√† gi√° tr·ªã!");
            return;
        }

        try {
            let response = await fetch("http://localhost:3000/write-modbus", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ register: parseInt(register), value: parseInt(value) })
            });

            let result = await response.json();
            document.getElementById("status").innerText = result.message || "Ghi th√†nh c√¥ng!";
        } catch (error) {
            document.getElementById("status").innerText = "L·ªói ghi d·ªØ li·ªáu: " + error.message;
        }
    }

    async function fetchModbusData() {
        let deviceIp = document.getElementById("deviceIp").value;
        let slaveId = document.getElementById("slaveId").value;

        try {
            let response = await fetch("http://localhost:3000/read-modbus");
            if (!response.ok) throw new Error("L·ªói k·∫øt n·ªëi: " + response.status);

            let data = await response.json();
            console.log("üì° D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", data);

            // Hi·ªÉn th·ªã JSON tr√™n giao di·ªán
            document.getElementById("json-output").textContent = JSON.stringify(data, null, 2);

            // T√¨m d·ªØ li·ªáu theo IP + Slave ID
            let deviceData = data.find(device => device.ip === deviceIp && device.slaveId == slaveId);

            if (deviceData) {
                document.getElementById("val1").innerText = deviceData.values[0].toFixed(2);
                document.getElementById("val2").innerText = deviceData.values[1].toFixed(2);
                document.getElementById("val3").innerText = deviceData.values[2].toFixed(2);
                document.getElementById("val4").innerText = deviceData.values[3].toFixed(2);
                document.getElementById("val5").innerText = deviceData.values[4].toFixed(2);
            } else {
                document.getElementById("modbus-data").innerText = "Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã v·ªõi IP v√† Slave ID n√†y.";
            }

        } catch (error) {
            console.error("‚ùå L·ªói khi ƒë·ªçc Modbus:", error);
            document.getElementById("modbus-data").innerText = "L·ªói khi ƒë·ªçc d·ªØ li·ªáu t·ª´ Modbus.";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("logout").addEventListener("click", function () {
            window.location.href = "index.html"; // Quay l·∫°i trang ƒëƒÉng nh·∫≠p
        });
    });
    function viewDetails(ip, slaveId) {
        window.location.href = `OTT1.html?ip=${ip}&slaveId=${slaveId}`;
    }
</script>
